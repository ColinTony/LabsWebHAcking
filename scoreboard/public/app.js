
const roasts = ["[01] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[02] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[03] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[04] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[05] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[06] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[07] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[08] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[09] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[10] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[11] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[12] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[13] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[14] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[15] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[16] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[17] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[18] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[19] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[20] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[21] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[22] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[23] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[24] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[25] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[26] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[27] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[28] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[29] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[30] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[31] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[32] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[33] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[34] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[35] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[36] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[37] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[38] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[39] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[40] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[41] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[42] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[43] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[44] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[45] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[46] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[47] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[48] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[49] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[50] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[51] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[52] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[53] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[54] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[55] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[56] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[57] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[58] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[59] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[60] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[61] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[62] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[63] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[64] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[65] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[66] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[67] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[68] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[69] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[70] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[71] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[72] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[73] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[74] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[75] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[76] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[77] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[78] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[79] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[80] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[81] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[82] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[83] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[84] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[85] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[86] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[87] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[88] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[89] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[90] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[91] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[92] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[93] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[94] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[95] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[96] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[97] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[98] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[99] c0l1nr00t: ese payload tropezó con un <div> y se cayó.", "[100] c0l1nr00t: ese payload tropezó con un <div> y se cayó."];

function htmlCard(c) {
  const url = c.subdomain === 'bover.lab' ? 'http://lab/bover' : `http://${c.subdomain}/`;
  return `<div class="card">
    <h3>${c.name}</h3>
    <div class="meta"><b>Track:</b> ${c.track} · <b>Dificultad:</b> ${c.difficulty}</div>
    <div class="meta"><b>Subdominio:</b> <code>${c.subdomain}</code></div>
    <div class="actions">
      <a href="${url}" target="_blank">Ir al reto</a>
      <button onclick="exportWriteup('${c.slug}')">Exportar writeup</button>
    </div>
  </div>`;
}

async function refresh() {
  const state = await fetch('/score/state').then(r=>r.json());
  const chals = await fetch('/score/list').then(r=>r.json());
  const doneFlags = state.completed || [];
  const total = chals.length;
  const pct = Math.round((doneFlags.length/total)*100);
  document.getElementById('bar').style.width = pct + '%';
  document.getElementById('percent').textContent = pct+'%';
  // filters
  const tf = document.getElementById('trackFilter').value;
  const df = document.getElementById('diffFilter').value;
  const filtered = chals.filter(c=>(!tf||c.track==tf)&&(!df||c.difficulty==df));
  document.getElementById('cards').innerHTML = filtered.map(c=>htmlCard(c)).join('');
  // achievements
  document.getElementById('achList').innerHTML = (state.stats.achievements||[]).map(a=>`<li>${a}</li>`).join('');
}

function addTerm(msg) {
  const t = document.getElementById('term');
  const p = document.createElement('div');
  p.textContent = msg;
  t.appendChild(p);
  t.scrollTop = t.scrollHeight;
}

document.getElementById('talk').onclick = ()=>{
  const r = roasts[Math.floor(Math.random()*roasts.length)];
  addTerm(r);
};

document.getElementById('giveup').onclick = ()=>{
  addTerm('c0l1nr00t: YOU LOSE. Vuelve cuando el buffer no te desborde la paciencia.');
  document.querySelector('.grid').innerHTML='';
};

document.getElementById('trackFilter').onchange = refresh;
document.getElementById('diffFilter').onchange = refresh;
document.getElementById('dailyBtn').onclick = ()=>addTerm('c0l1nr00t: Daily armada (mock).');
document.getElementById('weeklyBtn').onclick = ()=>addTerm('c0l1nr00t: Weekly armada (mock).');
document.getElementById('resetRoutine').onclick = ()=>addTerm('c0l1nr00t: Rutina reiniciada (mock).');

async function exportWriteup(slug) {
  const chals = await fetch('/score/list').then(r=>r.json());
  const c = chals.find(x=>x.slug===slug);
  const tpl = `# Writeup — ${c.name}
Autor: c0l1nr00t
Track: ${c.track} | Dificultad: ${c.difficulty}
Subdominio: ${c.subdomain}

## Objetivo
[Describe el objetivo del reto.]

## Vector de ataque
[Describe el vector.]

## PoC
[Incluye payload/requests.]

## Mitigación
[Medidas recomendadas.]

## Lecciones
[Qué aprendiste.]

`;
  const blob = new Blob([tpl],{type:'text/markdown'});
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = slug + "-writeup.md";
  a.click();
}

refresh();
